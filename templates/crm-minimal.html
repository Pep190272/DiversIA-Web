<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Minimal - DiversIA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
        }
    </style>
</head>
<body>
    <!-- Barra superior con logout -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand">CRM Minimal - DiversIA</span>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/" target="_blank">
                    üåê Ver Web
                </a>
                <a class="nav-link" href="#" onclick="logout()">
                    <i class="bi bi-power"></i> Cerrar Sesi√≥n
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Botones de acci√≥n -->
        <div class="row mb-4">
            <div class="col-12">
                <button class="btn btn-primary me-2" onclick="showAddForm()">A√±adir Empresa</button>
                <button class="btn btn-success me-2" onclick="showImportForm()">Importar CSV</button>
                <button class="btn btn-warning me-2" onclick="exportCSV()">Exportar CSV</button>
                <a href="/email-marketing?admin=true" class="btn btn-outline-info me-2">üìß Email Marketing</a>
                <a href="/tasks" class="btn btn-outline-primary me-2">üìã Tareas</a>
                <a href="/colaboradores" class="btn btn-outline-warning me-2">üë• Colaboradores</a>
                <a href="/asociaciones-crm" class="btn btn-outline-success me-2">üè¢ Asociaciones</a>
                <a href="/usuarios-neurodivergentes" class="btn btn-outline-info me-2">üß† Usuarios ND</a>
                <button class="btn btn-info me-2" onclick="loadCompanies()">Actualizar</button>
                <button class="btn btn-danger" onclick="clearAllCompanies()">Eliminar Todas</button>
            </div>
        </div>
        
        <!-- Formulario a√±adir empresa -->
        <div id="addForm" class="card mb-4" style="display: none;">
            <div class="card-header">
                <h5>A√±adir Nueva Empresa</h5>
            </div>
            <div class="card-body">
                <form id="companyForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nombre Empresa *</label>
                                <input type="text" class="form-control" id="nombre" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Tel√©fono</label>
                                <input type="text" class="form-control" id="telefono">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Sector</label>
                                <input type="text" class="form-control" id="sector">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Ciudad</label>
                                <input type="text" class="form-control" id="ciudad">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Guardar Empresa</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddForm()">Cancelar</button>
                </form>
            </div>
        </div>
        
        <!-- Formulario importar CSV -->
        <div id="importForm" class="card mb-4" style="display: none;">
            <div class="card-header">
                <h5>Importar CSV</h5>
            </div>
            <div class="card-body">
                <form id="csvForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label">Archivo CSV</label>
                        <input type="file" class="form-control" id="csvFile" accept=".csv" required>
                        <div class="form-text">
                            <strong>Formato DiversIA:</strong> Empresa, Email, Telefono, Sector, Ciudad, Fecha, Acciones
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">Importar</button>
                    <button type="button" class="btn btn-secondary" onclick="hideImportForm()">Cancelar</button>
                </form>
            </div>
        </div>
        
        <!-- Lista de empresas -->
        <div class="card">
            <div class="card-header">
                <h5>Empresas Registradas (<span id="companyCount">0</span>)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Empresa</th>
                                <th>Email</th>
                                <th>Tel√©fono</th>
                                <th>Sector</th>
                                <th>Ciudad</th>
                                <th>Fecha</th>
                                <th>Notas</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="companiesTable">
                            <tr>
                                <td colspan="8" class="text-center">Cargando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar empresa -->
    <div class="modal fade" id="editCompanyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‚úèÔ∏è Editar Empresa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCompanyForm">
                        <input type="hidden" id="editCompanyId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nombre de la Empresa</label>
                                    <input type="text" class="form-control" id="editNombre" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="editEmail">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Tel√©fono</label>
                                    <input type="text" class="form-control" id="editTelefono">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Sector</label>
                                    <select class="form-select" id="editSector">
                                        <option value="">Seleccionar sector</option>
                                        <option value="Tecnolog√≠a">Tecnolog√≠a</option>
                                        <option value="Salud">Salud</option>
                                        <option value="Educaci√≥n">Educaci√≥n</option>
                                        <option value="Finanzas">Finanzas</option>
                                        <option value="Retail">Retail</option>
                                        <option value="Manufactura">Manufactura</option>
                                        <option value="Otros">Otros</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Ciudad</label>
                                    <input type="text" class="form-control" id="editCiudad">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Fecha de Contacto</label>
                                    <input type="date" class="form-control" id="editFechaContacto">
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">Notas Adicionales</label>
                                    <textarea class="form-control" id="editNotas" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="saveCompanyEdit()">üíæ Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Cargar empresas al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            loadCompanies();
            
            // Formulario empresa
            document.getElementById('companyForm').addEventListener('submit', handleAddCompany);
            
            // Formulario CSV
            document.getElementById('csvForm').addEventListener('submit', handleImportCSV);
        });
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show notification`;
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }
        
        async function loadCompanies() {
            try {
                const response = await fetch('/api/minimal/companies');
                const companies = await response.json();
                
                const tbody = document.getElementById('companiesTable');
                const countSpan = document.getElementById('companyCount');
                
                countSpan.textContent = companies.length;
                
                if (companies.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No hay empresas registradas</td></tr>';
                    return;
                }
                
                tbody.innerHTML = companies.map(company => `
                    <tr>
                        <td>${company.id}</td>
                        <td><strong>${company.nombre}</strong>
                            ${company.origen ? `<br><small class="text-muted">${company.origen === 'web_registro' ? 'üåê Web' : 'üìÑ CSV'}</small>` : ''}
                        </td>
                        <td><a href="mailto:${company.email}">${company.email}</a></td>
                        <td>${company.telefono || '-'}</td>
                        <td>${company.sector || '-'}</td>
                        <td>${company.ciudad || '-'}</td>
                        <td>${company.fecha_contacto || new Date(company.created_at).toLocaleDateString()}</td>
                        <td title="${company.notas || company.descripcion || ''}">${(company.notas || company.descripcion) ? (company.notas || company.descripcion).substring(0, 50) + '...' : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1" onclick="editCompany(${company.id})">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCompany(${company.id})">
                                üóëÔ∏è Eliminar
                            </button>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                showNotification('Error cargando empresas: ' + error.message, 'danger');
            }
        }
        
        function showAddForm() {
            document.getElementById('addForm').style.display = 'block';
            document.getElementById('importForm').style.display = 'none';
        }
        
        function hideAddForm() {
            document.getElementById('addForm').style.display = 'none';
            document.getElementById('companyForm').reset();
        }
        
        function showImportForm() {
            document.getElementById('importForm').style.display = 'block';
            document.getElementById('addForm').style.display = 'none';
        }
        
        function hideImportForm() {
            document.getElementById('importForm').style.display = 'none';
            document.getElementById('csvForm').reset();
        }
        
        async function handleAddCompany(event) {
            event.preventDefault();
            
            const formData = {
                nombre: document.getElementById('nombre').value,
                email: document.getElementById('email').value,
                telefono: document.getElementById('telefono').value,
                sector: document.getElementById('sector').value,
                ciudad: document.getElementById('ciudad').value
            };
            
            try {
                const response = await fetch('/api/minimal/companies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Empresa creada correctamente');
                    hideAddForm();
                    loadCompanies();
                } else {
                    showNotification('Error: ' + result.error, 'danger');
                }
            } catch (error) {
                showNotification('Error de conexi√≥n: ' + error.message, 'danger');
            }
        }
        
        async function handleImportCSV(event) {
            event.preventDefault();
            
            const formData = new FormData();
            formData.append('csv_file', document.getElementById('csvFile').files[0]);
            
            try {
                const response = await fetch('/api/minimal/import-csv', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`CSV importado: ${result.created} empresas creadas`);
                    hideImportForm();
                    loadCompanies();
                } else {
                    showNotification('Error: ' + result.error, 'danger');
                }
            } catch (error) {
                showNotification('Error de conexi√≥n: ' + error.message, 'danger');
            }
        }
        
        async function deleteCompany(id) {
            if (!confirm('¬øEliminar esta empresa?')) return;
            
            try {
                const response = await fetch(`/api/minimal/companies/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Empresa eliminada');
                    loadCompanies();
                } else {
                    showNotification('Error: ' + result.error, 'danger');
                }
            } catch (error) {
                showNotification('Error de conexi√≥n: ' + error.message, 'danger');
            }
        }
        
        async function clearAllCompanies() {
            if (!confirm('¬øEliminar TODAS las empresas? Esta acci√≥n no se puede deshacer.')) return;
            if (!confirm('CONFIRMACI√ìN FINAL: Se eliminar√°n todas las empresas.')) return;
            
            try {
                const response = await fetch('/api/minimal/companies/clear', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(result.message);
                    loadCompanies();
                } else {
                    showNotification('Error: ' + result.error, 'danger');
                }
            } catch (error) {
                showNotification('Error de conexi√≥n: ' + error.message, 'danger');
            }
        }
        
        async function editCompany(id) {
            try {
                // Obtener datos de la empresa
                const response = await fetch(`/api/minimal/companies/${id}`);
                const result = await response.json();
                
                if (result.success) {
                    const company = result.company;
                    
                    // Llenar el formulario de edici√≥n
                    document.getElementById('editCompanyId').value = company.id;
                    document.getElementById('editNombre').value = company.nombre || '';
                    document.getElementById('editEmail').value = company.email || '';
                    document.getElementById('editTelefono').value = company.telefono || '';
                    document.getElementById('editSector').value = company.sector || '';
                    document.getElementById('editCiudad').value = company.ciudad || '';
                    document.getElementById('editFechaContacto').value = company.fecha_contacto || '';
                    document.getElementById('editNotas').value = company.notas || '';
                    
                    // Mostrar el modal
                    const modal = new bootstrap.Modal(document.getElementById('editCompanyModal'));
                    modal.show();
                } else {
                    showNotification('Error al cargar empresa: ' + result.error, 'danger');
                }
            } catch (error) {
                showNotification('Error de conexi√≥n: ' + error.message, 'danger');
            }
        }
        
        async function saveCompanyEdit() {
            const companyId = document.getElementById('editCompanyId').value;
            
            const updateData = {
                nombre: document.getElementById('editNombre').value,
                email: document.getElementById('editEmail').value,
                telefono: document.getElementById('editTelefono').value,
                sector: document.getElementById('editSector').value,
                ciudad: document.getElementById('editCiudad').value,
                fecha_contacto: document.getElementById('editFechaContacto').value,
                notas: document.getElementById('editNotas').value
            };
            
            try {
                const response = await fetch(`/api/minimal/companies/${companyId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Empresa actualizada correctamente');
                    
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editCompanyModal'));
                    modal.hide();
                    
                    // Recargar tabla
                    loadCompanies();
                } else {
                    showNotification('Error al actualizar: ' + result.error, 'danger');
                }
            } catch (error) {
                showNotification('Error de conexi√≥n: ' + error.message, 'danger');
            }
        }

        function logout() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                window.location.href = '/admin/logout-new';
            }
        }
        
        function exportCSV() {
            window.location.href = '/api/minimal/export-csv';
        }
    </script>
</body>
</html>