<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Leads Generales - DiversIA</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .lead-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .lead-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .nd-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        .no-nd-badge {
            background: #f3e5f5;
            color: #7b1fa2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        .converted-badge {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-0">üìù CRM Leads Generales</h1>
                        <p class="text-muted">Personas que completaron el test "Haz mi test" - Captaci√≥n inicial</p>
                    </div>
                    <div>
                        <a href="/crm-minimal" class="btn btn-secondary me-2">
                            ‚Üê Volver al CRM
                        </a>
                        <button class="btn btn-success me-2" onclick="exportAllLeads()">
                            üìä Exportar Leads
                        </button>
                        <button class="btn btn-primary" onclick="loadLeads()">
                            üîÑ Actualizar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estad√≠sticas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Total Leads</h5>
                        <h2 class="text-primary" id="total-leads">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Neurodivergentes</h5>
                        <h2 class="text-info" id="nd-leads">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">No Neurodivergentes</h5>
                        <h2 class="text-purple" id="no-nd-leads">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Convertidos</h5>
                        <h2 class="text-success" id="converted-leads">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros y Acciones -->
        <div class="row mb-4">
            <div class="col-md-3">
                <select class="form-select" id="filter-type" onchange="filterLeads()">
                    <option value="">Todos los leads</option>
                    <option value="nd">Solo neurodivergentes</option>
                    <option value="no-nd">Solo no neurodivergentes</option>
                    <option value="converted">Solo convertidos</option>
                    <option value="not-converted">No convertidos</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" id="search-input" placeholder="Buscar por nombre o email..." onkeyup="searchLeads()">
            </div>
            <div class="col-md-6">
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleSelectAll()" id="select-all-btn">
                        ‚òê Seleccionar Todo
                    </button>
                    <button class="btn btn-sm btn-success" onclick="exportSelected()" id="export-selected-btn" disabled>
                        üìä Exportar Seleccionados
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteSelected()" id="delete-selected-btn" disabled>
                        üóëÔ∏è Eliminar Seleccionados
                    </button>
                    <button class="btn btn-sm btn-info" onclick="exportAllLeads()">
                        üìã Exportar Todos
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Informaci√≥n de selecci√≥n -->
        <div class="row mb-3" id="selection-info" style="display: none;">
            <div class="col-12">
                <div class="alert alert-info mb-0">
                    <span id="selected-count">0</span> leads seleccionados
                </div>
            </div>
        </div>

        <!-- Lista de leads -->
        <div class="row">
            <div class="col-12">
                <div id="leads-container">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar lead -->
    <div class="modal fade" id="editLeadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Lead</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="editModalBody">
                    <!-- Contenido din√°mico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveLeadChanges()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allLeads = [];
        let currentEditingLead = null;

        // Cargar datos al inicio
        document.addEventListener('DOMContentLoaded', function() {
            loadLeads();
        });

        async function loadLeads() {
            try {
                const response = await fetch('/api/leads-generales');
                allLeads = await response.json();
                
                selectedLeads.clear(); // Limpiar selecci√≥n al recargar
                updateStatistics();
                displayLeads(allLeads);
                updateSelectionUI();
                
            } catch (error) {
                console.error('Error loading leads:', error);
                document.getElementById('leads-container').innerHTML = 
                    '<div class="alert alert-danger">Error cargando leads</div>';
            }
        }

        function updateStatistics() {
            const total = allLeads.length;
            const ndLeads = allLeads.filter(lead => lead.tipo_neurodivergencia).length;
            const noNdLeads = total - ndLeads;
            const converted = allLeads.filter(lead => lead.convertido_a_perfil).length;

            document.getElementById('total-leads').textContent = total;
            document.getElementById('nd-leads').textContent = ndLeads;
            document.getElementById('no-nd-leads').textContent = noNdLeads;
            document.getElementById('converted-leads').textContent = converted;
        }

        let selectedLeads = new Set();

        function displayLeads(leads) {
            const container = document.getElementById('leads-container');
            
            if (leads.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No hay leads registrados a√∫n</div>';
                return;
            }

            let html = '';
            leads.forEach(lead => {
                const isNd = lead.tipo_neurodivergencia && lead.tipo_neurodivergencia !== '';
                const badge = isNd ? 
                    `<span class="nd-badge">${lead.tipo_neurodivergencia.toUpperCase()}</span>` :
                    `<span class="no-nd-badge">No ND</span>`;
                
                const convertedBadge = lead.convertido_a_perfil ? 
                    `<span class="converted-badge ms-2">‚úì Convertido</span>` : '';

                const isSelected = selectedLeads.has(lead.id);
                const selectedClass = isSelected ? 'border-primary bg-light' : '';

                html += `
                    <div class="lead-card ${selectedClass}" style="position: relative;">
                        <div class="row">
                            <div class="col-md-1">
                                <div class="form-check">
                                    <input class="form-check-input lead-checkbox" type="checkbox" 
                                           id="lead-${lead.id}" value="${lead.id}" 
                                           ${isSelected ? 'checked' : ''}
                                           onchange="toggleLeadSelection(${lead.id})">
                                </div>
                            </div>
                            <div class="col-md-5" onclick="editLead(${lead.id})" style="cursor: pointer;">
                                <h6 class="mb-1">${lead.nombre} ${lead.apellidos}</h6>
                                <small class="text-muted">${lead.email}</small>
                                <div class="mt-2">${badge}${convertedBadge}</div>
                            </div>
                            <div class="col-md-3" onclick="editLead(${lead.id})" style="cursor: pointer;">
                                <small class="text-muted">Ciudad:</small><br>
                                <span>${lead.ciudad}</span><br>
                                <small class="text-muted">Tel√©fono:</small><br>
                                <span>${lead.telefono || 'No especificado'}</span>
                            </div>
                            <div class="col-md-2" onclick="editLead(${lead.id})" style="cursor: pointer;">
                                <small class="text-muted">Registrado:</small><br>
                                <span>${new Date(lead.created_at).toLocaleDateString()}</span><br>
                                <small class="text-muted">Experiencia:</small><br>
                                <span class="text-truncate d-block" style="max-width: 120px;">
                                    ${lead.experiencia_laboral || 'No especificada'}
                                </span>
                            </div>
                            <div class="col-md-1">
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="deleteIndividualLead(${lead.id}, event)"
                                        title="Eliminar lead">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function editLead(leadId) {
            try {
                const response = await fetch(`/api/leads-generales/${leadId}`);
                const lead = await response.json();
                currentEditingLead = lead;

                const modalBody = document.getElementById('editModalBody');
                modalBody.innerHTML = `
                    <form id="editLeadForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nombre</label>
                                    <input type="text" class="form-control" id="edit-nombre" value="${lead.nombre}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Apellidos</label>
                                    <input type="text" class="form-control" id="edit-apellidos" value="${lead.apellidos}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tel√©fono</label>
                                    <input type="text" class="form-control" id="edit-telefono" value="${lead.telefono || ''}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Ciudad</label>
                                    <input type="text" class="form-control" id="edit-ciudad" value="${lead.ciudad}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">Habilidades</label>
                                    <textarea class="form-control" id="edit-habilidades" rows="2">${lead.habilidades || ''}</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">Experiencia Laboral</label>
                                    <textarea class="form-control" id="edit-experiencia" rows="3">${lead.experiencia_laboral || ''}</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">Intereses Laborales</label>
                                    <textarea class="form-control" id="edit-intereses" rows="3">${lead.intereses_laborales || ''}</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit-convertido" ${lead.convertido_a_perfil ? 'checked' : ''}>
                                    <label class="form-check-label" for="edit-convertido">
                                        Convertido a perfil espec√≠fico
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                `;

                new bootstrap.Modal(document.getElementById('editLeadModal')).show();

            } catch (error) {
                console.error('Error loading lead details:', error);
                alert('Error cargando detalles del lead');
            }
        }

        async function saveLeadChanges() {
            if (!currentEditingLead) return;

            try {
                const formData = {
                    nombre: document.getElementById('edit-nombre').value,
                    apellidos: document.getElementById('edit-apellidos').value,
                    telefono: document.getElementById('edit-telefono').value,
                    ciudad: document.getElementById('edit-ciudad').value,
                    habilidades: document.getElementById('edit-habilidades').value,
                    experiencia_laboral: document.getElementById('edit-experiencia').value,
                    intereses_laborales: document.getElementById('edit-intereses').value,
                    convertido_a_perfil: document.getElementById('edit-convertido').checked
                };

                const response = await fetch(`/api/leads-generales/${currentEditingLead.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editLeadModal')).hide();
                    loadLeads(); // Recargar datos
                    alert('Lead actualizado correctamente');
                } else {
                    alert('Error actualizando lead: ' + result.error);
                }

            } catch (error) {
                console.error('Error saving lead:', error);
                alert('Error guardando cambios');
            }
        }

        function filterLeads() {
            updateLeadDisplay();
            updateSelectionUI();
        }

        function searchLeads() {
            updateLeadDisplay();
            updateSelectionUI();
        }

        async function exportAllLeads() {
            try {
                const response = await fetch('/api/leads-generales/export-all');
                
                if (response.ok) {
                    // Descargar archivo CSV
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `todos_los_leads_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    alert(`‚úÖ ${allLeads.length} leads exportados correctamente`);
                } else {
                    const result = await response.json();
                    alert('‚ùå Error exportando leads: ' + result.error);
                }
            } catch (error) {
                console.error('Error exporting all leads:', error);
                alert('‚ùå Error exportando todos los leads');
            }
        }

        function toggleLeadSelection(leadId) {
            if (selectedLeads.has(leadId)) {
                selectedLeads.delete(leadId);
            } else {
                selectedLeads.add(leadId);
            }
            updateSelectionUI();
            updateLeadDisplay();
        }

        function toggleSelectAll() {
            const currentLeads = getCurrentFilteredLeads();
            const allSelected = currentLeads.every(lead => selectedLeads.has(lead.id));
            
            if (allSelected) {
                // Deseleccionar todos los visibles
                currentLeads.forEach(lead => selectedLeads.delete(lead.id));
            } else {
                // Seleccionar todos los visibles
                currentLeads.forEach(lead => selectedLeads.add(lead.id));
            }
            
            updateSelectionUI();
            displayLeads(currentLeads);
        }

        function updateSelectionUI() {
            const count = selectedLeads.size;
            const selectAllBtn = document.getElementById('select-all-btn');
            const exportBtn = document.getElementById('export-selected-btn');
            const deleteBtn = document.getElementById('delete-selected-btn');
            const selectionInfo = document.getElementById('selection-info');
            const selectedCountSpan = document.getElementById('selected-count');
            
            // Actualizar contador
            selectedCountSpan.textContent = count;
            
            // Mostrar/ocultar informaci√≥n de selecci√≥n
            if (count > 0) {
                selectionInfo.style.display = 'block';
                exportBtn.disabled = false;
                deleteBtn.disabled = false;
            } else {
                selectionInfo.style.display = 'none';
                exportBtn.disabled = true;
                deleteBtn.disabled = true;
            }
            
            // Actualizar texto del bot√≥n de seleccionar todo
            const currentLeads = getCurrentFilteredLeads();
            const allSelected = currentLeads.length > 0 && currentLeads.every(lead => selectedLeads.has(lead.id));
            selectAllBtn.innerHTML = allSelected ? '‚òëÔ∏è Deseleccionar Todo' : '‚òê Seleccionar Todo';
        }

        function getCurrentFilteredLeads() {
            const filter = document.getElementById('filter-type').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            let filteredLeads = allLeads;
            
            // Aplicar filtro por tipo
            switch(filter) {
                case 'nd':
                    filteredLeads = filteredLeads.filter(lead => lead.tipo_neurodivergencia);
                    break;
                case 'no-nd':
                    filteredLeads = filteredLeads.filter(lead => !lead.tipo_neurodivergencia);
                    break;
                case 'converted':
                    filteredLeads = filteredLeads.filter(lead => lead.convertido_a_perfil);
                    break;
                case 'not-converted':
                    filteredLeads = filteredLeads.filter(lead => !lead.convertido_a_perfil);
                    break;
            }
            
            // Aplicar b√∫squeda
            if (searchTerm) {
                filteredLeads = filteredLeads.filter(lead => 
                    lead.nombre.toLowerCase().includes(searchTerm) ||
                    lead.apellidos.toLowerCase().includes(searchTerm) ||
                    lead.email.toLowerCase().includes(searchTerm)
                );
            }
            
            return filteredLeads;
        }

        function updateLeadDisplay() {
            const filteredLeads = getCurrentFilteredLeads();
            displayLeads(filteredLeads);
        }

        async function deleteSelected() {
            if (selectedLeads.size === 0) {
                alert('No hay leads seleccionados');
                return;
            }
            
            const count = selectedLeads.size;
            
            // PROTECCI√ìN DE DATOS M√öLTIPLE
            
            // Primera confirmaci√≥n
            if (!confirm(`‚ö†Ô∏è ATENCI√ìN: ¬øEst√°s seguro de que quieres eliminar ${count} leads seleccionados?\n\nEsta acci√≥n eliminar√° permanentemente los datos de estas personas.\n\n¬øDeseas continuar?`)) {
                return;
            }
            
            // Segunda confirmaci√≥n para eliminaciones masivas
            if (count > 5) {
                if (!confirm(`üõë CONFIRMACI√ìN ADICIONAL REQUERIDA\n\nVas a eliminar ${count} leads (m√°s de 5).\n\nEsto podr√≠a afectar significativamente tu base de datos.\n\n¬øEst√°s COMPLETAMENTE SEGURO de que quieres continuar?`)) {
                    return;
                }
            }
            
            try {
                // Primer intento - verificar confirmaci√≥n
                let response = await fetch('/api/leads-generales/bulk-delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        lead_ids: Array.from(selectedLeads),
                        confirmed: true
                    })
                });
                
                let result = await response.json();
                
                // Si requiere doble confirmaci√≥n
                if (result.requires_double_confirmation) {
                    if (!confirm(`üîí CONFIRMACI√ìN FINAL REQUERIDA\n\nPor seguridad, eliminar ${count} elementos requiere una confirmaci√≥n adicional.\n\nEsta es tu √öLTIMA oportunidad para cancelar.\n\n¬øProceder con la eliminaci√≥n?`)) {
                        return;
                    }
                    
                    // Segundo intento con doble confirmaci√≥n
                    response = await fetch('/api/leads-generales/bulk-delete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            lead_ids: Array.from(selectedLeads),
                            confirmed: true,
                            double_confirmed: true
                        })
                    });
                    
                    result = await response.json();
                }
                
                if (result.success) {
                    alert(`‚úÖ ${result.deleted_count} leads eliminados correctamente\n\n${result.backup_created ? 'üõ°Ô∏è Backup de seguridad creado' : ''}`);
                    selectedLeads.clear();
                    loadLeads(); // Recargar datos
                } else {
                    alert('‚ùå Error eliminando leads: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting selected leads:', error);
                alert('‚ùå Error eliminando leads seleccionados');
            }
        }

        async function exportSelected() {
            if (selectedLeads.size === 0) {
                alert('No hay leads seleccionados para exportar');
                return;
            }
            
            try {
                const response = await fetch('/api/leads-generales/bulk-export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ lead_ids: Array.from(selectedLeads) })
                });
                
                if (response.ok) {
                    // Descargar archivo CSV
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `leads_seleccionados_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    alert(`‚úÖ ${selectedLeads.size} leads exportados correctamente`);
                } else {
                    const result = await response.json();
                    alert('‚ùå Error exportando leads: ' + result.error);
                }
            } catch (error) {
                console.error('Error exporting selected leads:', error);
                alert('‚ùå Error exportando leads seleccionados');
            }
        }

        async function deleteIndividualLead(leadId, event) {
            event.stopPropagation(); // Evitar que se abra el modal de edici√≥n
            
            const lead = allLeads.find(l => l.id === leadId);
            if (!lead) return;
            
            // PROTECCI√ìN DE DATOS INDIVIDUAL
            if (!confirm(`‚ö†Ô∏è ELIMINACI√ìN DE DATOS PERSONALES\n\n¬øEst√°s seguro de que quieres eliminar a:\n\nüë§ ${lead.nombre} ${lead.apellidos}\nüìß ${lead.email}\n\nEsta acci√≥n eliminar√° permanentemente todos los datos de esta persona.\n\n¬øDeseas continuar?`)) {
                return;
            }
            
            try {
                // Primer intento - verificar confirmaci√≥n
                let response = await fetch(`/api/leads-generales/${leadId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ confirmed: true })
                });
                
                const result = await response.json();
                
                if (result.requires_confirmation) {
                    // Si el backend requiere confirmaci√≥n adicional
                    if (!confirm(`üîí CONFIRMACI√ìN DE SEGURIDAD REQUERIDA\n\nPor la protecci√≥n de datos, confirma nuevamente que quieres eliminar a:\n${lead.nombre} ${lead.apellidos}\n\n¬øProceder?`)) {
                        return;
                    }
                    
                    // Segundo intento con confirmaci√≥n
                    response = await fetch(`/api/leads-generales/${leadId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ confirmed: true, double_confirmed: true })
                    });
                    
                    result = await response.json();
                }
                
                if (result.success) {
                    alert(`‚úÖ Lead eliminado correctamente\n\n${result.backup_info ? 'üõ°Ô∏è ' + result.backup_info : ''}`);
                    selectedLeads.delete(leadId); // Remover de selecci√≥n si estaba seleccionado
                    loadLeads(); // Recargar datos
                } else {
                    alert('‚ùå Error eliminando lead: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting lead:', error);
                alert('‚ùå Error eliminando lead');
            }
        }
    </script>
</body>
</html>