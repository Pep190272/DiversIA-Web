<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Leads - DiversIA</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .lead-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: white;
        }
        .lead-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .time-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        .status-new {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .status-contacted {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
        }
        .auto-refresh {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-0">üìä Dashboard de Leads en Tiempo Real</h1>
                        <p class="text-muted">Registros de personas interesadas en DiversIA</p>
                    </div>
                    <div>
                        <a href="/crm-minimal" class="btn btn-secondary me-2">
                            ‚Üê Volver al CRM
                        </a>
                        <button class="btn btn-success me-2" onclick="exportAllLeads()">
                            üìä Exportar CSV
                        </button>
                        <button class="btn btn-primary auto-refresh" onclick="loadLeads()">
                            üîÑ Actualizar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estad√≠sticas Simplificadas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Total Registros</h5>
                        <h2 class="text-primary" id="total-leads">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Hoy</h5>
                        <h2 class="text-success" id="today-leads">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Esta Semana</h5>
                        <h2 class="text-info" id="week-leads">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Este Mes</h5>
                        <h2 class="text-warning" id="month-leads">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros Simples -->
        <div class="row mb-4">
            <div class="col-md-4">
                <input type="text" class="form-control" id="search-input" placeholder="Buscar por nombre o email..." onkeyup="searchLeads()">
            </div>
            <div class="col-md-4">
                <select class="form-select" id="filter-source" onchange="filterLeads()">
                    <option value="">Todos los or√≠genes</option>
                    <option value="redes_sociales">Redes Sociales</option>
                    <option value="google">Google</option>
                    <option value="recomendacion">Recomendaci√≥n</option>
                    <option value="evento">Evento</option>
                    <option value="medios">Medios</option>
                    <option value="otro">Otro</option>
                </select>
            </div>
            <div class="col-md-4">
                <select class="form-select" id="filter-time" onchange="filterLeads()">
                    <option value="">Todos los tiempos</option>
                    <option value="today">Hoy</option>
                    <option value="week">Esta semana</option>
                    <option value="month">Este mes</option>
                </select>
            </div>
        </div>

        <!-- Lista de Leads -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Registros Recientes</h5>
                        <small class="text-muted">Actualizaci√≥n autom√°tica cada 30 segundos</small>
                    </div>
                    <div class="card-body">
                        <div id="leads-container">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-2 text-muted">Cargando registros...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ver detalles -->
    <div class="modal fade" id="leadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles del Registro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modal-body">
                    <!-- Contenido din√°mico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="contactLead()">Marcar como Contactado</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allLeads = [];
        let filteredLeads = [];
        let selectedLeadId = null;

        // Cargar leads al inicio
        document.addEventListener('DOMContentLoaded', function() {
            loadLeads();
            // Auto-refresh cada 30 segundos
            setInterval(loadLeads, 30000);
        });

        function loadLeads(retryCount = 0) {
            // Mostrar indicador de carga
            document.getElementById('leads-container').innerHTML = 
                '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div></div>';
                
            fetch('/api/leads-generales')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    allLeads = Array.isArray(data) ? data : [];
                    updateStats();
                    displayLeads(allLeads);
                    console.log(`‚úÖ Leads cargados correctamente: ${allLeads.length} registros`);
                })
                .catch(error => {
                    console.error('Error cargando leads:', error);
                    
                    // Reintentar autom√°ticamente hasta 3 veces
                    if (retryCount < 3) {
                        console.log(`üîÑ Reintentando carga (${retryCount + 1}/3) en 2 segundos...`);
                        setTimeout(() => loadLeads(retryCount + 1), 2000);
                    } else {
                        document.getElementById('leads-container').innerHTML = 
                            '<div class="alert alert-warning">‚ö†Ô∏è Error cargando registros. <button class="btn btn-sm btn-primary" onclick="loadLeads()">üîÑ Reintentar</button></div>';
                    }
                });
        }

        function updateStats() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);

            const todayCount = allLeads.filter(lead => new Date(lead.created_at) >= today).length;
            const weekCount = allLeads.filter(lead => new Date(lead.created_at) >= weekAgo).length;
            const monthCount = allLeads.filter(lead => new Date(lead.created_at) >= monthAgo).length;

            document.getElementById('total-leads').textContent = allLeads.length;
            document.getElementById('today-leads').textContent = todayCount;
            document.getElementById('week-leads').textContent = weekCount;
            document.getElementById('month-leads').textContent = monthCount;
        }

        function displayLeads(leads) {
            const container = document.getElementById('leads-container');
            
            if (leads.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4">No hay registros disponibles</div>';
                return;
            }

            const html = leads.map(lead => {
                const date = new Date(lead.created_at);
                const timeAgo = getTimeAgo(date);
                const isNew = (Date.now() - date.getTime()) < 24 * 60 * 60 * 1000; // Menos de 24 horas
                
                return `
                    <div class="lead-card ${isNew ? 'status-new' : ''}" onclick="showLeadDetails(${lead.id})">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="mb-1">${lead.nombre} ${lead.apellidos}</h6>
                                <small class="text-muted">${lead.email}</small>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Ciudad:</small><br>
                                <span>${lead.ciudad || 'No especificada'}</span>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Origen:</small><br>
                                <span class="badge bg-light text-dark">${getSourceLabel(lead.motivaciones)}</span>
                            </div>
                            <div class="col-md-2 text-end">
                                <span class="time-badge">${timeAgo}</span>
                                ${isNew ? '<br><small class="text-warning">‚ú® Nuevo</small>' : ''}
                            </div>
                        </div>
                        ${lead.intereses_laborales ? `
                            <div class="row mt-2">
                                <div class="col-12">
                                    <small class="text-muted">Intereses:</small><br>
                                    <span class="text-truncate d-block">${lead.intereses_laborales}</span>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Hace unos segundos';
            if (diffInSeconds < 3600) return `Hace ${Math.floor(diffInSeconds / 60)} min`;
            if (diffInSeconds < 86400) return `Hace ${Math.floor(diffInSeconds / 3600)} h`;
            return `Hace ${Math.floor(diffInSeconds / 86400)} d√≠as`;
        }

        function getSourceLabel(source) {
            const labels = {
                'redes_sociales': 'Redes Sociales',
                'google': 'Google',
                'recomendacion': 'Recomendaci√≥n',
                'evento': 'Evento',
                'medios': 'Medios',
                'otro': 'Otro'
            };
            return labels[source] || 'No especificado';
        }

        function showLeadDetails(leadId) {
            const lead = allLeads.find(l => l.id === leadId);
            if (!lead) return;

            selectedLeadId = leadId;
            const modalBody = document.getElementById('modal-body');
            
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>Nombre:</strong><br>${lead.nombre} ${lead.apellidos}
                    </div>
                    <div class="col-md-6">
                        <strong>Email:</strong><br>${lead.email}
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <strong>Tel√©fono:</strong><br>${lead.telefono || 'No proporcionado'}
                    </div>
                    <div class="col-md-6">
                        <strong>Ciudad:</strong><br>${lead.ciudad}
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <strong>Origen:</strong><br>${getSourceLabel(lead.motivaciones)}
                    </div>
                    <div class="col-md-6">
                        <strong>Registro:</strong><br>${new Date(lead.created_at).toLocaleString('es-ES')}
                    </div>
                </div>
                ${lead.intereses_laborales ? `
                    <div class="row mt-3">
                        <div class="col-12">
                            <strong>Intereses:</strong><br>${lead.intereses_laborales}
                        </div>
                    </div>
                ` : ''}
            `;

            new bootstrap.Modal(document.getElementById('leadModal')).show();
        }

        function searchLeads() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const filtered = allLeads.filter(lead => 
                lead.nombre.toLowerCase().includes(query) ||
                lead.apellidos.toLowerCase().includes(query) ||
                lead.email.toLowerCase().includes(query)
            );
            displayLeads(filtered);
        }

        function filterLeads() {
            const sourceFilter = document.getElementById('filter-source').value;
            const timeFilter = document.getElementById('filter-time').value;
            
            let filtered = allLeads;
            
            if (sourceFilter) {
                filtered = filtered.filter(lead => lead.motivaciones === sourceFilter);
            }
            
            if (timeFilter) {
                const now = new Date();
                let cutoff;
                
                if (timeFilter === 'today') {
                    cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                } else if (timeFilter === 'week') {
                    cutoff = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                } else if (timeFilter === 'month') {
                    cutoff = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                }
                
                filtered = filtered.filter(lead => new Date(lead.created_at) >= cutoff);
            }
            
            displayLeads(filtered);
        }

        function exportAllLeads() {
            window.location.href = '/api/export-general-leads';
        }

        function contactLead() {
            if (!selectedLeadId) return;
            
            // Aqu√≠ podr√≠as agregar l√≥gica para marcar como contactado
            alert('Funcionalidad de contacto pendiente de implementar');
        }
    </script>
</body>
</html>