<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Leads Generales - DiversIA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .lead-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .lead-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .nd-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        .no-nd-badge {
            background: #f3e5f5;
            color: #7b1fa2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        .converted-badge {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-0">üìù CRM Leads Generales</h1>
                        <p class="text-muted">Personas que completaron el test "Haz mi test" - Captaci√≥n inicial</p>
                    </div>
                    <div>
                        <a href="/crm-minimal" class="btn btn-secondary me-2">
                            ‚Üê Volver al CRM
                        </a>
                        <button class="btn btn-success me-2" onclick="exportAllLeads()">
                            üìä Exportar Leads
                        </button>
                        <button class="btn btn-primary" onclick="loadLeads()">
                            üîÑ Actualizar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estad√≠sticas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Total Leads</h5>
                        <h2 class="text-primary" id="total-leads">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Neurodivergentes</h5>
                        <h2 class="text-info" id="nd-leads">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">No Neurodivergentes</h5>
                        <h2 class="text-purple" id="no-nd-leads">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Convertidos</h5>
                        <h2 class="text-success" id="converted-leads">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="row mb-4">
            <div class="col-md-4">
                <select class="form-select" id="filter-type" onchange="filterLeads()">
                    <option value="">Todos los leads</option>
                    <option value="nd">Solo neurodivergentes</option>
                    <option value="no-nd">Solo no neurodivergentes</option>
                    <option value="converted">Solo convertidos</option>
                    <option value="not-converted">No convertidos</option>
                </select>
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control" id="search-input" placeholder="Buscar por nombre o email..." onkeyup="searchLeads()">
            </div>
            <div class="col-md-4">
                <button class="btn btn-outline-primary" onclick="showBulkActions()">
                    üìß Acciones Masivas
                </button>
            </div>
        </div>

        <!-- Lista de leads -->
        <div class="row">
            <div class="col-12">
                <div id="leads-container">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar lead -->
    <div class="modal fade" id="editLeadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Lead</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="editModalBody">
                    <!-- Contenido din√°mico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveLeadChanges()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allLeads = [];
        let currentEditingLead = null;

        // Cargar datos al inicio
        document.addEventListener('DOMContentLoaded', function() {
            loadLeads();
        });

        async function loadLeads() {
            try {
                const response = await fetch('/api/leads-generales');
                allLeads = await response.json();
                
                updateStatistics();
                displayLeads(allLeads);
                
            } catch (error) {
                console.error('Error loading leads:', error);
                document.getElementById('leads-container').innerHTML = 
                    '<div class="alert alert-danger">Error cargando leads</div>';
            }
        }

        function updateStatistics() {
            const total = allLeads.length;
            const ndLeads = allLeads.filter(lead => lead.tipo_neurodivergencia).length;
            const noNdLeads = total - ndLeads;
            const converted = allLeads.filter(lead => lead.convertido_a_perfil).length;

            document.getElementById('total-leads').textContent = total;
            document.getElementById('nd-leads').textContent = ndLeads;
            document.getElementById('no-nd-leads').textContent = noNdLeads;
            document.getElementById('converted-leads').textContent = converted;
        }

        function displayLeads(leads) {
            const container = document.getElementById('leads-container');
            
            if (leads.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No hay leads registrados a√∫n</div>';
                return;
            }

            let html = '';
            leads.forEach(lead => {
                const isNd = lead.tipo_neurodivergencia && lead.tipo_neurodivergencia !== '';
                const badge = isNd ? 
                    `<span class="nd-badge">${lead.tipo_neurodivergencia.toUpperCase()}</span>` :
                    `<span class="no-nd-badge">No ND</span>`;
                
                const convertedBadge = lead.convertido_a_perfil ? 
                    `<span class="converted-badge ms-2">‚úì Convertido</span>` : '';

                html += `
                    <div class="lead-card" onclick="editLead(${lead.id})">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="mb-1">${lead.nombre} ${lead.apellidos}</h6>
                                <small class="text-muted">${lead.email}</small>
                                <div class="mt-2">${badge}${convertedBadge}</div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Ciudad:</small><br>
                                <span>${lead.ciudad}</span><br>
                                <small class="text-muted">Tel√©fono:</small><br>
                                <span>${lead.telefono || 'No especificado'}</span>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Registrado:</small><br>
                                <span>${new Date(lead.created_at).toLocaleDateString()}</span><br>
                                <small class="text-muted">Experiencia:</small><br>
                                <span class="text-truncate d-block" style="max-width: 150px;">
                                    ${lead.experiencia_laboral || 'No especificada'}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function editLead(leadId) {
            try {
                const response = await fetch(`/api/leads-generales/${leadId}`);
                const lead = await response.json();
                currentEditingLead = lead;

                const modalBody = document.getElementById('editModalBody');
                modalBody.innerHTML = `
                    <form id="editLeadForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nombre</label>
                                    <input type="text" class="form-control" id="edit-nombre" value="${lead.nombre}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Apellidos</label>
                                    <input type="text" class="form-control" id="edit-apellidos" value="${lead.apellidos}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tel√©fono</label>
                                    <input type="text" class="form-control" id="edit-telefono" value="${lead.telefono || ''}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Ciudad</label>
                                    <input type="text" class="form-control" id="edit-ciudad" value="${lead.ciudad}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">Habilidades</label>
                                    <textarea class="form-control" id="edit-habilidades" rows="2">${lead.habilidades || ''}</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">Experiencia Laboral</label>
                                    <textarea class="form-control" id="edit-experiencia" rows="3">${lead.experiencia_laboral || ''}</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">Intereses Laborales</label>
                                    <textarea class="form-control" id="edit-intereses" rows="3">${lead.intereses_laborales || ''}</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit-convertido" ${lead.convertido_a_perfil ? 'checked' : ''}>
                                    <label class="form-check-label" for="edit-convertido">
                                        Convertido a perfil espec√≠fico
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                `;

                new bootstrap.Modal(document.getElementById('editLeadModal')).show();

            } catch (error) {
                console.error('Error loading lead details:', error);
                alert('Error cargando detalles del lead');
            }
        }

        async function saveLeadChanges() {
            if (!currentEditingLead) return;

            try {
                const formData = {
                    nombre: document.getElementById('edit-nombre').value,
                    apellidos: document.getElementById('edit-apellidos').value,
                    telefono: document.getElementById('edit-telefono').value,
                    ciudad: document.getElementById('edit-ciudad').value,
                    habilidades: document.getElementById('edit-habilidades').value,
                    experiencia_laboral: document.getElementById('edit-experiencia').value,
                    intereses_laborales: document.getElementById('edit-intereses').value,
                    convertido_a_perfil: document.getElementById('edit-convertido').checked
                };

                const response = await fetch(`/api/leads-generales/${currentEditingLead.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editLeadModal')).hide();
                    loadLeads(); // Recargar datos
                    alert('Lead actualizado correctamente');
                } else {
                    alert('Error actualizando lead: ' + result.error);
                }

            } catch (error) {
                console.error('Error saving lead:', error);
                alert('Error guardando cambios');
            }
        }

        function filterLeads() {
            const filter = document.getElementById('filter-type').value;
            let filteredLeads = allLeads;

            switch(filter) {
                case 'nd':
                    filteredLeads = allLeads.filter(lead => lead.tipo_neurodivergencia);
                    break;
                case 'no-nd':
                    filteredLeads = allLeads.filter(lead => !lead.tipo_neurodivergencia);
                    break;
                case 'converted':
                    filteredLeads = allLeads.filter(lead => lead.convertido_a_perfil);
                    break;
                case 'not-converted':
                    filteredLeads = allLeads.filter(lead => !lead.convertido_a_perfil);
                    break;
            }

            displayLeads(filteredLeads);
        }

        function searchLeads() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const filteredLeads = allLeads.filter(lead => 
                lead.nombre.toLowerCase().includes(searchTerm) ||
                lead.apellidos.toLowerCase().includes(searchTerm) ||
                lead.email.toLowerCase().includes(searchTerm)
            );
            displayLeads(filteredLeads);
        }

        function exportAllLeads() {
            const dataStr = JSON.stringify(allLeads, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'leads_generales_' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function showBulkActions() {
            alert('Funci√≥n de acciones masivas (env√≠o de emails, etc.) - Pr√≥ximamente disponible');
        }
    </script>
</body>
</html>