<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Neurodivergentes - DiversIA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/lucide@0.263.1/dist/umd/lucide.js" rel="stylesheet">
    <style>
        .nd-card {
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        .nd-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .nd-tdah { border-left-color: #ff6b6b; }
        .nd-tea { border-left-color: #4ecdc4; }
        .nd-dislexia { border-left-color: #45b7d1; }
        .nd-discalculia { border-left-color: #96ceb4; }
        .nd-tourette { border-left-color: #feca57; }
        .nd-tel { border-left-color: #48dbfb; }
        .nd-disgrafia { border-left-color: #0abde3; }
        .nd-tps { border-left-color: #74b9ff; }
        .nd-altas { border-left-color: #ff9f43; }
        
        .stats-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #28a745;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .user-card {
            margin-bottom: 10px;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: white;
        }
        
        .tab-content {
            min-height: 400px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-0">üß† CRM Neurodivergentes</h1>
                        <p class="text-muted">Gesti√≥n completa de personas neurodivergentes registradas</p>
                    </div>
                    <div>
                        <a href="/crm-minimal" class="btn btn-secondary me-2">
                            ‚Üê Volver al CRM
                        </a>
                        <button class="btn btn-success me-2" onclick="exportAllData()">
                            üìä Exportar Todo
                        </button>
                        <a href="/admin/export/users.csv" class="btn btn-primary">
                            üìÅ Descargar CSV
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estad√≠sticas Generales -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h4 id="total-users">0</h4>
                        <p class="mb-0">Total Registrados</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h4 id="with-diagnosis">0</h4>
                        <p class="mb-0">Con Diagn√≥stico</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h4 id="job-seekers">0</h4>
                        <p class="mb-0">Buscando Empleo</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <h4 id="this-month">0</h4>
                        <p class="mb-0">Este Mes</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pesta√±as por Neurodivergencia -->
        <div class="row">
            <div class="col-12">
                <nav>
                    <div class="nav nav-tabs" id="nav-tab" role="tablist">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview-tab" role="tab">
                            üìä Resumen
                        </button>
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tdah-tab" role="tab" onclick="loadNeurodivergenceData('TDAH')">
                            üî• TDAH
                        </button>
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tea-tab" role="tab" onclick="loadNeurodivergenceData('TEA')">
                            üß© TEA
                        </button>
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#dislexia-tab" role="tab" onclick="loadNeurodivergenceData('Dislexia')">
                            üìö Dislexia
                        </button>
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#discalculia-tab" role="tab" onclick="loadNeurodivergenceData('Discalculia')">
                            üî¢ Discalculia
                        </button>
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tourette-tab" role="tab" onclick="loadNeurodivergenceData('Tourette'); console.log('Cargando datos Tourette');">
                            üéØ Tourette
                        </button>
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tel-tab" role="tab" onclick="loadNeurodivergenceData('TEL')">
                            üó£Ô∏è TEL
                        </button>
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#disgrafia-tab" role="tab" onclick="loadNeurodivergenceData('Disgraf√≠a')">
                            ‚úçÔ∏è Disgraf√≠a
                        </button>
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#otros-tab" role="tab" onclick="loadOtherTypes()">
                            ‚ûï Otros
                        </button>
                    </div>
                </nav>

                <div class="tab-content mt-3">
                    <!-- Resumen General -->
                    <div class="tab-pane fade show active" id="overview-tab">
                        <div class="row" id="overview-cards">
                            <!-- Se llenan din√°micamente -->
                        </div>
                    </div>

                    <!-- Pesta√±as espec√≠ficas -->
                    <div class="tab-pane fade" id="tdah-tab">
                        <div id="tdah-content">Cargando...</div>
                    </div>
                    <div class="tab-pane fade" id="tea-tab">
                        <div id="tea-content">Cargando...</div>
                    </div>
                    <div class="tab-pane fade" id="dislexia-tab">
                        <div id="dislexia-content">Cargando...</div>
                    </div>
                    <div class="tab-pane fade" id="discalculia-tab">
                        <div id="discalculia-content">Cargando...</div>
                    </div>
                    <div class="tab-pane fade" id="tourette-tab">
                        <div id="tourette-content">Cargando...</div>
                    </div>
                    <div class="tab-pane fade" id="tel-tab">
                        <div id="tel-content">Cargando...</div>
                    </div>
                    <div class="tab-pane fade" id="disgrafia-tab">
                        <div id="disgrafia-content">Cargando...</div>
                    </div>
                    <div class="tab-pane fade" id="otros-tab">
                        <div id="otros-content">Cargando...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalles de usuario -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles del Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="userModalBody">
                    <!-- Contenido din√°mico -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Cargar datos al inicio
        document.addEventListener('DOMContentLoaded', function() {
            loadOverviewData();
        });

        async function loadOverviewData() {
            try {
                const response = await fetch('/api/usuarios-neurodivergentes');
                const data = await response.json();
                
                console.log('Usuarios cargados:', data);
                document.getElementById('total-users').textContent = data.length || 0;
                
                // Crear tarjetas de resumen
                const overviewContainer = document.getElementById('overview-cards');
                overviewContainer.innerHTML = '';
                
                // Contar usuarios por tipo
                const usersByType = {};
                const types = ['tdah', 'tea', 'tel', 'dislexia', 'discalculia', 'disgrafia', 'tps', 'tourette', 'altas_capacidades'];
                const typeLabels = ['TDAH', 'TEA', 'TEL', 'Dislexia', 'Discalculia', 'Disgraf√≠a', 'TPS', 'Tourette', 'Altas Capacidades'];
                const colors = ['nd-tdah', 'nd-tea', 'nd-tel', 'nd-dislexia', 'nd-discalculia', 'nd-disgrafia', 'nd-tps', 'nd-tourette', 'nd-altas'];
                
                // Inicializar contadores
                types.forEach(type => usersByType[type] = 0);
                
                // Contar usuarios por tipo
                data.forEach(user => {
                    let tipoLower = user.tipo_neurodivergencia ? user.tipo_neurodivergencia.toLowerCase() : '';
                    
                    // Normalizar nombres de tipos
                    if (tipoLower === 's√≠ndrome de tourette') tipoLower = 'tourette';
                    if (tipoLower === 'altas capacidades' || tipoLower === 'superdotaci√≥n') tipoLower = 'altas_capacidades';
                    
                    if (usersByType.hasOwnProperty(tipoLower)) {
                        usersByType[tipoLower]++;
                    }
                });
                
                types.forEach((type, index) => {
                    const count = usersByType[type] || 0;
                    const card = `
                        <div class="col-md-4 col-lg-3 mb-3">
                            <div class="card nd-card ${colors[index]} position-relative" style="cursor: pointer;" onclick="switchToTab('${type.toLowerCase()}')">
                                <div class="card-body">
                                    <h5 class="card-title">${typeLabels[index]}</h5>
                                    <p class="card-text">${count} registrados</p>
                                    ${count > 0 ? `<div class="stats-badge">${count}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    overviewContainer.innerHTML += card;
                });
            } catch (error) {
                console.error('Error loading overview:', error);
            }
        }

        async function loadNeurodivergenceData(type) {
            console.log('üéØ Iniciando carga de datos para tipo:', type);
            const contentId = type.toLowerCase() + '-content';
            const container = document.getElementById(contentId);
            
            if (!container) {
                console.error('‚ùå No se encontr√≥ contenedor:', contentId);
                return;
            }
            
            container.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p>Cargando datos de ' + type + '...</p></div>';
            
            try {
                const response = await fetch('/api/usuarios-neurodivergentes');
                const allData = await response.json();
                console.log('üìä Todos los datos recibidos:', allData.length);
                console.log('üìã Tipos disponibles:', allData.map(u => u.tipo_neurodivergencia));
                
                // Filtrar por tipo de neurodivergencia con normalizaci√≥n
                const data = allData.filter(user => {
                    if (!user.tipo_neurodivergencia) return false;
                    
                    const userType = user.tipo_neurodivergencia.toLowerCase();
                    const searchType = type.toLowerCase();
                    
                    console.log(`üîç Comparando: "${userType}" con "${searchType}"`);
                    
                    // Manejar variaciones espec√≠ficas
                    if (searchType === 'tourette') {
                        const match = userType === 'tourette' || userType === 's√≠ndrome de tourette' || userType.includes('tourette');
                        console.log(`üéØ Tourette match para "${userType}":`, match);
                        return match;
                    }
                    
                    if (searchType === 'tel') {
                        const match = userType === 'tel' || userType === 'trastorno espec√≠fico del lenguaje' || userType.includes('tel');
                        console.log(`üó£Ô∏è TEL match para "${userType}":`, match);
                        return match;
                    }
                    
                    if (searchType === 'disgraf√≠a') {
                        const match = userType === 'disgraf√≠a' || userType === 'disgrafia' || userType.includes('disgraf');
                        console.log(`‚úçÔ∏è Disgraf√≠a match para "${userType}":`, match);
                        return match;
                    }
                    
                    return userType === searchType;
                });
                
                console.log('‚úÖ Datos filtrados para', type + ':', data.length);
                
                let html = `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>üë• ${type} - ${data.length} personas registradas</h4>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportTypeData('${type}')">
                            üìÅ Exportar ${type}
                        </button>
                    </div>
                `;
                
                if (data && data.length > 0) {
                    data.forEach(user => {
                        html += `
                            <div class="user-card">
                                <div class="row">
                                    <div class="col-md-4" onclick="showUserDetails('${user.id}')" style="cursor: pointer;">
                                        <strong>${user.nombre} ${user.apellidos}</strong><br>
                                        <small class="text-muted">${user.email}</small>
                                    </div>
                                    <div class="col-md-3" onclick="showUserDetails('${user.id}')" style="cursor: pointer;">
                                        üìç ${user.ciudad}<br>
                                        üì± ${user.telefono || 'No especificado'}
                                    </div>
                                    <div class="col-md-3" onclick="showUserDetails('${user.id}')" style="cursor: pointer;">
                                        ${user.diagnostico_formal ? '‚úÖ Diagn√≥stico formal' : '‚è≥ Sin diagn√≥stico'}
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-primary" onclick="editUser('${user.id}')" title="Editar">
                                                ‚úèÔ∏è
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.id}', '${user.nombre} ${user.apellidos}')" title="Borrar">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                        <small class="text-muted d-block mt-1">${new Date(user.created_at).toLocaleDateString()}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<div class="text-center text-muted py-4">No hay personas registradas con ' + type + '</div>';
                }
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading data:', error);
                container.innerHTML = '<div class="alert alert-danger">Error cargando datos</div>';
            }
        }

        async function showUserDetails(userId) {
            try {
                const response = await fetch(`/api/usuario/${userId}/editar`);
                const user = await response.json();
                
                const modalBody = document.getElementById('userModalBody');
                modalBody.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Informaci√≥n Personal</h6>
                            <p><strong>Nombre:</strong> ${user.nombre} ${user.apellidos}</p>
                            <p><strong>Email:</strong> ${user.email}</p>
                            <p><strong>Tel√©fono:</strong> ${user.telefono || 'No especificado'}</p>
                            <p><strong>Ciudad:</strong> ${user.ciudad}</p>
                            <p><strong>Fecha Nacimiento:</strong> ${user.fecha_nacimiento || 'No especificado'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Informaci√≥n Laboral</h6>
                            <p><strong>Neurodivergencia:</strong> ${user.tipo_neurodivergencia}</p>
                            <p><strong>Diagn√≥stico:</strong> ${user.diagnostico_formal ? 'S√≠' : 'No'}</p>
                            <p><strong>Experiencia:</strong> ${user.experiencia_laboral || 'No especificado'}</p>
                            <p><strong>Formaci√≥n:</strong> ${user.formacion_academica || 'No especificado'}</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Habilidades y Adaptaciones</h6>
                            <p><strong>Habilidades:</strong> ${user.habilidades || 'No especificado'}</p>
                            <p><strong>Intereses:</strong> ${user.intereses_laborales || 'No especificado'}</p>
                            <p><strong>Adaptaciones:</strong> ${user.adaptaciones_necesarias || 'No especificado'}</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12 text-center">
                            <button class="btn btn-primary me-2" onclick="editUser('${user.id}')">
                                ‚úèÔ∏è Editar Perfil
                            </button>
                            <button class="btn btn-danger" onclick="deleteUser('${user.id}', '${user.nombre} ${user.apellidos}')">
                                üóëÔ∏è Borrar Perfil
                            </button>
                        </div>
                    </div>
                `;
                
                new bootstrap.Modal(document.getElementById('userModal')).show();
            } catch (error) {
                console.error('Error loading user details:', error);
            }
        }

        // Nueva funci√≥n para editar usuario
        async function editUser(userId) {
            try {
                // Cerrar modal actual si est√° abierto
                const modal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
                if (modal) modal.hide();
                
                // Redirigir a p√°gina de edici√≥n
                window.open(`/crm-editar/${userId}`, '_blank');
            } catch (error) {
                console.error('Error opening edit page:', error);
                alert('Error al abrir editor de usuario');
            }
        }

        // Nueva funci√≥n para borrar usuario
        async function deleteUser(userId, userName) {
            if (!confirm(`¬øEst√°s seguro de que quieres borrar el perfil de "${userName}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/usuario/${userId}/borrar`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Perfil de "${userName}" borrado exitosamente`);
                    // Recargar datos
                    loadOverviewData();
                    // Cerrar modal si est√° abierto
                    const modal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
                    if (modal) modal.hide();
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('‚ùå Error al borrar usuario');
            }
        }

        function switchToTab(type) {
            console.log('Switching to tab:', type);
            
            // Para Tourette, usar su pesta√±a espec√≠fica
            if (type === 'tourette') {
                const touretteTab = document.querySelector(`[data-bs-target="#tourette-tab"]`);
                if (touretteTab) {
                    touretteTab.click();
                    return;
                }
            }
            
            // Para TEL, usar su pesta√±a espec√≠fica
            if (type === 'tel') {
                const telTab = document.querySelector(`[data-bs-target="#tel-tab"]`);
                if (telTab) {
                    telTab.click();
                    return;
                }
            }
            
            // Para Disgraf√≠a, usar su pesta√±a espec√≠fica
            if (type === 'disgrafia') {
                const disgrafiaTab = document.querySelector(`[data-bs-target="#disgrafia-tab"]`);
                if (disgrafiaTab) {
                    disgrafiaTab.click();
                    return;
                }
            }
            
            // Para otros tipos especiales, usar la pesta√±a "Otros"  
            if (['tps', 'altas_capacidades'].includes(type)) {
                const othersTab = document.querySelector(`[data-bs-target="#otros-tab"]`);
                if (othersTab) {
                    othersTab.click();
                    return;
                }
            }
            
            const tabButton = document.querySelector(`[data-bs-target="#${type}-tab"]`);
            if (tabButton) {
                tabButton.click();
            }
        }

        async function exportAllData() {
            try {
                const response = await fetch('/api/usuarios-neurodivergentes');
                const data = await response.json();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'reporte_neurodivergentes.json';
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error exporting data:', error);
            }
        }

        function loadOtherTypes() {
            // Cargar Tourette, Dispraxia, Ansiedad, Bipolar, Altas Capacidades
            const container = document.getElementById('otros-content');
            container.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
            
            fetch('/api/usuarios-neurodivergentes')
                .then(response => response.json())
                .then(allUsers => {
                    console.log('DEBUG: Todos los usuarios:', allUsers);
                    console.log('DEBUG: Tipos encontrados:', [...new Set(allUsers.map(u => u.tipo_neurodivergencia))]);
                    const types = ['tps', 'altas_capacidades'];
                    const typeLabels = ['TPS', 'Altas Capacidades'];
                    // Buscar tanto por valor exacto como por variaciones
                    const results = types.map((type, index) => {
                        return allUsers.filter(user => {
                            const userType = user.tipo_neurodivergencia?.toLowerCase();
                            if (type === 'tourette') {
                                return userType === 'tourette' || userType === 's√≠ndrome de tourette' || userType.includes('tourette');
                            }
                            return userType === type;
                        });
                    });
                
                    let html = '<div class="row">';
                
                results.forEach((data, index) => {
                    html += `
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6>${typeLabels[index]} - ${data.length} registros</h6>
                                </div>
                                <div class="card-body">
                                    ${data.slice(0, 3).map(user => `
                                        <div class="border-bottom pb-2 mb-2" onclick="showUserDetails(${user.id})">
                                            <strong>${user.nombre} ${user.apellidos}</strong><br>
                                            <small class="text-muted">${user.email} - ${user.ciudad}</small>
                                        </div>
                                    `).join('')}
                                    ${data.length > 3 ? `<small class="text-muted">Y ${data.length - 3} m√°s...</small>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                    html += '</div>';
                    
                    // Si no hay datos, mostrar mensaje de debug
                    if (results.every(r => r.length === 0)) {
                        html += `<div class="alert alert-warning">
                            <h6>Debug: No se encontraron usuarios en tipos especiales</h6>
                            <p>Total usuarios: ${allUsers.length}</p>
                            <p>Tipos encontrados: ${[...new Set(allUsers.map(u => u.tipo_neurodivergencia))].join(', ')}</p>
                        </div>`;
                    }
                    
                    container.innerHTML = html;
                }).catch(error => {
                console.error('Error loading other types:', error);
                container.innerHTML = `<div class="alert alert-danger">
                    <h6>Error cargando datos</h6>
                    <p>Error: ${error.message}</p>
                    <button onclick="loadOtherTypes()" class="btn btn-sm btn-primary">Reintentar</button>
                </div>`;
            });
        }
    </script>
</body>
</html>