<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asociaciones - CRM DiversIA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
        }
        .status-badge {
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <!-- Barra superior con logout -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand">🏢 Asociaciones - DiversIA CRM</span>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/crm-minimal">📊 CRM Principal</a>
                <a class="nav-link" href="/" target="_blank">
                    🌐 Ver Web
                </a>
                <a class="nav-link" href="#" onclick="logout()">
                    <i class="bi bi-power"></i> Cerrar Sesión
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Botones de acción -->
        <div class="row mb-4">
            <div class="col-12">
                <button class="btn btn-warning me-2" onclick="exportCSV()">📤 Exportar CSV</button>
                <a href="/tareas" class="btn btn-outline-primary me-2">📋 Tareas</a>
                <a href="/colaboradores" class="btn btn-outline-warning me-2">👥 Colaboradores</a>
                <button class="btn btn-info me-2" onclick="loadAsociaciones()">🔄 Actualizar</button>
                <button class="btn btn-danger" onclick="showBulkActions()">⚙️ Acciones en Lote</button>
            </div>
        </div>
        
        <!-- Lista de asociaciones -->
        <div class="card">
            <div class="card-header">
                <h5>Asociaciones Registradas (<span id="asociacionCount">0</span>)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Asociación</th>
                                <th>País/Ciudad</th>
                                <th>Contacto</th>
                                <th>Email/Teléfono</th>
                                <th>Estado</th>
                                <th>Neurodivergencias</th>
                                <th>Servicios</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="asociacionesTable">
                            <tr>
                                <td colspan="9" class="text-center">Cargando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar asociación -->
    <div class="modal fade" id="editAsociacionModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">✏️ Editar Asociación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editAsociacionForm">
                        <input type="hidden" id="editAsociacionId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nombre de la Asociación</label>
                                    <input type="text" class="form-control" id="editNombreAsociacion" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Acrónimo</label>
                                    <input type="text" class="form-control" id="editAcronimo">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">País</label>
                                    <select class="form-select" id="editPais">
                                        <option value="ES">España</option>
                                        <option value="MX">México</option>
                                        <option value="AR">Argentina</option>
                                        <option value="CO">Colombia</option>
                                        <option value="PE">Perú</option>
                                        <option value="CL">Chile</option>
                                        <option value="VE">Venezuela</option>
                                        <option value="EC">Ecuador</option>
                                        <option value="OTHER">Otro</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Ciudad</label>
                                    <input type="text" class="form-control" id="editCiudad">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Estado</label>
                                    <select class="form-select" id="editEstado">
                                        <option value="pendiente">Pendiente</option>
                                        <option value="verificada">Verificada</option>
                                        <option value="rechazada">Rechazada</option>
                                        <option value="activa">Activa</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="editEmail">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Teléfono</label>
                                    <input type="text" class="form-control" id="editTelefono">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Sitio Web</label>
                                    <input type="url" class="form-control" id="editSitioWeb">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Dirección</label>
                                    <input type="text" class="form-control" id="editDireccion">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nombre del Contacto</label>
                                    <input type="text" class="form-control" id="editContactoNombre">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Cargo del Contacto</label>
                                    <input type="text" class="form-control" id="editContactoCargo">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Años de Funcionamiento</label>
                                    <input type="number" class="form-control" id="editAñosFuncionamiento">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Número de Socios</label>
                                    <input type="number" class="form-control" id="editNumeroSocios">
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">Descripción</label>
                                    <textarea class="form-control" id="editDescripcion" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="saveAsociacionEdit()">💾 Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Cargar asociaciones al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            loadAsociaciones();
        });
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show notification`;
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }
        
        async function loadAsociaciones() {
            try {
                const response = await fetch('/api/asociaciones');
                const asociaciones = await response.json();
                
                const tbody = document.getElementById('asociacionesTable');
                const countSpan = document.getElementById('asociacionCount');
                
                countSpan.textContent = asociaciones.length;
                
                if (asociaciones.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No hay asociaciones registradas</td></tr>';
                    return;
                }
                
                tbody.innerHTML = asociaciones.map(asoc => `
                    <tr>
                        <td>${asoc.id}</td>
                        <td>
                            <strong>${asoc.nombre_asociacion}</strong>
                            ${asoc.acronimo ? `<br><small class="text-muted">(${asoc.acronimo})</small>` : ''}
                        </td>
                        <td>
                            ${asoc.pais}<br>
                            <small class="text-muted">${asoc.ciudad}</small>
                        </td>
                        <td>
                            ${asoc.contacto_nombre || '-'}<br>
                            <small class="text-muted">${asoc.contacto_cargo || ''}</small>
                        </td>
                        <td>
                            <a href="mailto:${asoc.email}">${asoc.email}</a><br>
                            <small class="text-muted">${asoc.telefono || '-'}</small>
                        </td>
                        <td>
                            <span class="badge ${getStatusBadgeClass(asoc.estado)} status-badge">
                                ${getStatusText(asoc.estado)}
                            </span>
                        </td>
                        <td title="${asoc.neurodivergencias_atendidas}">
                            ${asoc.neurodivergencias_atendidas ? asoc.neurodivergencias_atendidas.substring(0, 30) + '...' : '-'}
                        </td>
                        <td title="${asoc.servicios}">
                            ${asoc.servicios ? asoc.servicios.substring(0, 30) + '...' : '-'}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1" onclick="editAsociacion(${asoc.id})">
                                ✏️ Editar
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteAsociacion(${asoc.id})">
                                🗑️ Eliminar
                            </button>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                showNotification('Error cargando asociaciones: ' + error.message, 'danger');
            }
        }
        
        function getStatusBadgeClass(estado) {
            switch(estado) {
                case 'verificada': return 'bg-success';
                case 'activa': return 'bg-primary';
                case 'rechazada': return 'bg-danger';
                default: return 'bg-warning';
            }
        }
        
        function getStatusText(estado) {
            switch(estado) {
                case 'verificada': return 'Verificada';
                case 'activa': return 'Activa';
                case 'rechazada': return 'Rechazada';
                default: return 'Pendiente';
            }
        }
        
        async function editAsociacion(id) {
            try {
                // Obtener datos de la asociación
                const response = await fetch(`/api/asociaciones/${id}`);
                const result = await response.json();
                
                if (result.success) {
                    const asoc = result.asociacion;
                    
                    // Llenar el formulario de edición
                    document.getElementById('editAsociacionId').value = asoc.id;
                    document.getElementById('editNombreAsociacion').value = asoc.nombre_asociacion || '';
                    document.getElementById('editAcronimo').value = asoc.acronimo || '';
                    document.getElementById('editPais').value = asoc.pais || '';
                    document.getElementById('editCiudad').value = asoc.ciudad || '';
                    document.getElementById('editEstado').value = asoc.estado || '';
                    document.getElementById('editEmail').value = asoc.email || '';
                    document.getElementById('editTelefono').value = asoc.telefono || '';
                    document.getElementById('editSitioWeb').value = asoc.sitio_web || '';
                    document.getElementById('editDireccion').value = asoc.direccion || '';
                    document.getElementById('editContactoNombre').value = asoc.contacto_nombre || '';
                    document.getElementById('editContactoCargo').value = asoc.contacto_cargo || '';
                    document.getElementById('editAñosFuncionamiento').value = asoc.años_funcionamiento || '';
                    document.getElementById('editNumeroSocios').value = asoc.numero_socios || '';
                    document.getElementById('editDescripcion').value = asoc.descripcion || '';
                    
                    // Mostrar el modal
                    const modal = new bootstrap.Modal(document.getElementById('editAsociacionModal'));
                    modal.show();
                } else {
                    showNotification('Error al cargar asociación: ' + result.error, 'danger');
                }
            } catch (error) {
                showNotification('Error de conexión: ' + error.message, 'danger');
            }
        }
        
        async function saveAsociacionEdit() {
            const asociacionId = document.getElementById('editAsociacionId').value;
            
            const updateData = {
                nombre_asociacion: document.getElementById('editNombreAsociacion').value,
                acronimo: document.getElementById('editAcronimo').value,
                pais: document.getElementById('editPais').value,
                ciudad: document.getElementById('editCiudad').value,
                estado: document.getElementById('editEstado').value,
                email: document.getElementById('editEmail').value,
                telefono: document.getElementById('editTelefono').value,
                sitio_web: document.getElementById('editSitioWeb').value,
                direccion: document.getElementById('editDireccion').value,
                contacto_nombre: document.getElementById('editContactoNombre').value,
                contacto_cargo: document.getElementById('editContactoCargo').value,
                años_funcionamiento: document.getElementById('editAñosFuncionamiento').value,
                numero_socios: document.getElementById('editNumeroSocios').value,
                descripcion: document.getElementById('editDescripcion').value
            };
            
            try {
                const response = await fetch(`/api/asociaciones/${asociacionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Asociación actualizada correctamente');
                    
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editAsociacionModal'));
                    modal.hide();
                    
                    // Recargar tabla
                    loadAsociaciones();
                } else {
                    showNotification('Error al actualizar: ' + result.error, 'danger');
                }
            } catch (error) {
                showNotification('Error de conexión: ' + error.message, 'danger');
            }
        }
        
        async function deleteAsociacion(id) {
            if (!confirm('¿Eliminar esta asociación? Esta acción no se puede deshacer.')) return;
            
            try {
                const response = await fetch(`/api/asociaciones/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Asociación eliminada correctamente');
                    loadAsociaciones();
                } else {
                    showNotification('Error al eliminar: ' + result.error, 'danger');
                }
            } catch (error) {
                showNotification('Error de conexión: ' + error.message, 'danger');
            }
        }
        
        function exportCSV() {
            window.location.href = '/api/asociaciones/export-csv';
        }
        
        function showBulkActions() {
            // Implementar acciones en lote más adelante si es necesario
            showNotification('Función de acciones en lote pendiente de implementar', 'info');
        }

        function logout() {
            if (confirm('¿Cerrar sesión?')) {
                window.location.href = '/admin/logout-new';
            }
        }
    </script>
</body>
</html>